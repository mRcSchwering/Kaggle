---
title: "Keine Panik auf der Titanic"
author: "Marc Schwering"
output:
  html_document:
    number_sections: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: readable
    highlight: tango
---







# Introduction

This is my first Kaggle script.
Since, the Titanic set is recommended for beginners I will try this one.
I will just go through data quality, feature extraction, modelling, and 
prediction like I would always do.
However, feature extraction is often not really straight forward,
so maybe I go back and forth a little bit.

I have looked into some scripts for the Titanic set.
A lot of people use a random forest as first choice.
However, I have seen nobody using a plain old linear discriminant analysis.
This is usually one of my first choices, so I will use it here.

```{r}
library(data.table) # database-like tables
library(vcd) # actually just for mosaic plot
library(ggplot2) # general plots
library(sda) # shrinkage discriminant analysis
```

Let's load the data.
I'm belong to the `data.table` people here.

```{r}
test <- read.csv("../input/test.csv")
train <- read.csv("../input/train.csv")
test <- data.table(test)
train <- data.table(train)
str(train)
str(test)
```

Some of the factors should be `character`, so...

```{r}
train[, Name := as.character(Name)]
train[, Ticket := as.character(Ticket)]
train[, Cabin := as.character(Cabin)]
train[, Survived := as.factor(Survived)]
test[, Name := as.character(Name)]
test[, Ticket := as.character(Ticket)]
test[, Cabin := as.character(Cabin)]
```










# Data Quality

Here, I basically go through the current features and see if there is something
important like missing values or weird values.
I don't really look at distributions and correlations yet.

## PasserngerId

This is just a sanity check.

```{r results='asis'}
cat(sprintf(
  "train has %d rows and %d unique passenger IDs\n",
  nrow(train), length(unique(train$PassengerId))
))
cat(sprintf(
  "test has %d rows and %d unique passenger IDs\n",
  nrow(test), length(unique(test$PassengerId))
))
```

## Survived

This is a sanity check for the training labels.

```{r}
table(train$Survived)
```

## Pclass

```{r}
table(train$Pclass)
table(test$Pclass)
```

## Name

This will be an interesting feature.
However, here I just check if it contains empty values or weirdly short names.

```{r}
head(train$Name)
head(test$Name)
any(nchar(train$Name) < 3)
any(nchar(test$Name) < 3)
```

## Sex

```{r}
table(train$Sex)
table(test$Sex)
```

## Age

```{r}
summary(train$Age)
summary(test$Age)
```

Ouh, there are many NAs. We will have to think of something for these.
Age range seems reasonable:
from 2 months to 80 years old.

## SibSp and Parch

```{r}
table(train$SibSp)
table(test$SibSp)
table(train$Parch)
table(test$Parch)
```

## Ticket

There is probably a lot to extract here.

```{r}
head(train$Ticket)
head(test$Ticket)
any(train$Ticket  == "")
any(test$Ticket == "")
```

## Fare

```{r}
summary(train$Fare)
summary(test$Fare)
test[is.na(Fare), ]
```

There is one NA *Fare* in the test set.
We keep this for now.
Also, in both *test* and *train* there are some weirdly high values of 512.3.
What's up with these?

```{r}
train[Fare > 512, ]
test[Fare > 512, ]
```

And there are free rides:

```{r}
train[Fare == 0, ]
test[Fare == 0, ]
```

I wonder whether these were people that got a board last minute or so.
That would explain why there are a lot of NAs for them.

## Cabin

```{r}
head(train$Cabin)
head(test$Cabin)
table(train$Cabin == "")
table(test$Cabin == "")
```

Ouh, this looks bad.
Most are empty.

## Embarked

```{r}
table(train$Embarked)
table(test$Embarked)
train[Embarked == "", ]
```

In the training set there are 2 empty *Embarked* entries.
Both survived, maybe they didn't embark.














# Feature Extraction

So now we know there are a few features which can still be extracted.
I will do the feature extraction for the training set.
But eventually I have to write a function that handles the feature extraction.

## Names

I am starting with the *Names* column.
Obviously one can extract *Surnames* and *Titles* from the names.
This is something I have seen in `mrisdal`'s script.

### Titles

This is from `mrisdal`'s script and I will do it the same way.

```{r}
train$Title <- gsub('(.*, )|(\\..*)', '', train$Name)
table(train$Title)
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
train[Title == "Mlle", Title := "Miss"]
train[Title == "Ms", Title := "Miss"]
train[Title == "Mme", Title := "Mrs"]
train[Title %in% rare_title, Title := "Rare Title"]
table(train$Title, train$Sex)
```

### Surnames

The surnames part is also form `mrisdal`.

```{r}
train$Surname <- vapply(
  train$Name, 
  function(x) strsplit(x, "[,. ]")[[1]][1],
  character(1)
)
length(unique(train$Surname))
any(train$Surname == "")
```

### Identical Surnames

However, looking at the surnames I think for identifying families it might be
handy to have the number of people with identical surnames aboard.

```{r}
counts <- table(train$Surname)
train$SNCount <- vapply(
  train$Surname, 
  function(sn) counts[names(counts) == sn],
  integer(1)
)
hist(train$SNCount, breaks = 20)
```

## Age

One important factor for survival is definitely the age.
There is a natural step in the age feature at the age of 18.
I will extract that as a binary feature.

```{r}
train$isChild <- as.integer(train$Age < 18)
table(train$isChild)
```

## Families

Families probably stayed together.
So knowning the families would be good for prediction.
Using cabin information, Sibling/Spouses and Parent/Children, and the names
one could try to link family members.
For now I will just extract the general family size.

```{r}
train$FMembers <- train$SibSp + train$Parch + 1
```

## Ticket

The tickets are not only numbers.

```{r}
txt <- gsub("[0-9\\. /]", "", train$Ticket)
(txt <- toupper(unique(txt)))
```

### Ticket Text

This seems to tell me the embarkment as well.
At this point I don't know what to do with it yet. 
I will just save it as factor for now.

```{r}
train$TicketText <- toupper(gsub("[0-9\\. /]", "", train$Ticket))
```


## Cabins

The Cabin feature is very sparse.
However, for those that have values, we can extract the deck and the number of
cabins.

### Deck

The first character in the Cabin number is the deck.

```{r}
train$Deck <- vapply(
  train$Cabin, 
  function(x) strsplit(x, "")[[1]][1],
  character(1)
)
train[is.na(Deck), Deck := ""]
table(train$Deck)
```

### Number of Cabins

In some cases several cabins are listed.
Maybe that will be important.

```{r}
train$nCabins <- vapply(
  train$Cabin, 
  function(x) length(strsplit(x, " ")[[1]]),
  integer(1)
)
table(train$nCabins)
```

From this I will also derive a binary feature.

```{r}
train$hasCabin <- as.integer(train$nCabins > 0)
```





















# Features

Enough with creating more features.
Now I look at feature distributions and correlations to find dependencies.
I might also change some features if it makes sense.
As said before, this is not really a straight forward process.

First, I will define some functions for plotting.

```{r}
# color palette for Survived label
pal <- c("red", "blue")

# pearson corelation coefficients for SPLOM 
panel.cor <- function(x, y, digits = 2, cex.cor, ...) {
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  m <- cbind(x, y)
  m <- m[complete.cases(m), ]
  r <- cor(m[, 1], m[, 2])
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.5, txt)
}


```


## Numeric Features

```{r}
pairs(
  train[, .(Age, Fare, SibSp, Parch, FMembers, SNCount, nCabins)], 
  col = pal[train$Survived], 
  pch = 20,
  main = "Numeric Features -- Blue Survived", 
  lower.panel = panel.cor
)
```

I would have thought *SibSp* and *Parch* both correlate well with both *SNCount*
and *nCabins*.
But *FMembers* does that much better.
So it seems several cabins are listed on tickets for siblings, spouses, parents,
and children.
One could reduce these five features.
The rest doesn't show good correlation.
However, some feature look good for prediction.

## Age

Let's see if the age has a substantial effect on survival chances.
I rather use densities here to compare distributions with different counts.

```{r}
ggplot(train) +
  geom_density(aes(x = Age, fill = Survived), alpha = .5) +
  theme_classic() +
  theme(legend.position = "none")
```

Apart from the children, it seems that age does not have a substantial effect
on survival chances.
Maybe it is good in combination with another feature.
However, I want to use a linear discriminant analysis.
So, if I want to include such a kind of interaction term in the model, I
have to design it by hand.

But let's see the correlation for the binary feature *isChild*.

```{r}
mosaic(structable(train[, .(isChild, Survived)]), shade = TRUE)
```

This looks good.

## SibSp

```{r}
ggplot(train, aes(x = SibSp, fill = Survived)) +
  geom_bar(position = "dodge") + 
  theme_classic()
```

There seems to be a trend change for 1 sibling/spouse.
These are the only ones with more survivors.
A linear discriminant analysis would not be able to capture this.
I have to use dummy variables for this.

## Parch

```{r}
ggplot(train, aes(x = Parch, fill = Survived)) +
  geom_bar(position = "dodge") + 
  theme_classic()
```

They look very similar, which is not surprising.
They were correlated.

## FMembers

```{r}
ggplot(train, aes(x = FMembers, fill = Survived)) +
  geom_bar(position = "dodge") + 
  theme_classic()
```

I think here the trend is clearest (compared to *SibSp* and *Parch*).
I think about replacing these two features.
*FMembers* of 2, 3, and 4 seem to be important.

## SNCount

```{r}
ggplot(train, aes(x = SNCount, fill = Survived)) +
  geom_bar(position = "dodge") + 
  theme_classic()
```

Similar to *SibSp* and *Parch*.
They were also correlated.

## Ticket Text

```{r}
table(train$Survived, train$TicketText)
```

Some of these labels don't appear very often.
Maybe I should reduce them to the ones with at least 10 counts.

```{r}
tab <- table(train$TicketText)
(tab <- tab[tab > 10])
txt <-names(tab[-1])
txt <- vapply(
  train$TicketText, 
  function(i) { 
    idx <- which(txt %in% i) 
    if (length(idx) < 1) "" else txt[idx] 
  },
  character(1)
)
train$TicketText2 <- txt
ggplot(train, aes(x = TicketText2, fill = Survived)) +
  geom_bar(position = "dodge") + 
  theme_classic()
```

The "PC" label in the ticket might be a survival indicator.
I should set up a dummy variable for this.


## Fare

```{r}
ggplot(train) +
  geom_density(aes(x = Fare, fill = Survived), alpha = .5) +
  theme_classic()
ggplot(train) +
  geom_density(aes(x = Fare, fill = Survived), alpha = .5) +
  scale_x_continuous(trans = "log10") +
  theme_classic()
```

So, people who payed more seem to have better survival chances.

## Deck

```{r}
ggplot(train, aes(x = Deck, fill = Survived)) +
  geom_bar(position = "dodge") + 
  theme_classic()
```

Higher decks seem to have





